$schema: https://raw.githubusercontent.com/PowerShell/DSC/main/schemas/2023/08/config/document.json
metadata:
  winget:
    processor:
      identifier: "dscv3"
resources:
  # Modern WSL installation via WinGet (Store version)
  # This avoids the legacy WMI/WS-Man 'Access Denied' errors from the PS adapter
  - name: wsl-app
    type: Microsoft.WinGet/Package
    properties:
      id: 9P9TQF7MRM4R
      source: msstore

  # Ubuntu distribution via WinGet
  - name: ubuntu-distro
    type: Microsoft.WinGet/Package
    dependsOn:
      - "[resourceId('Microsoft.WinGet/Package', 'wsl-app')]"
    properties:
      id: Canonical.Ubuntu
      source: winget

  - name: wsl-environment-init
    type: Microsoft.DSC.Transitional/PowerShellScript
    dependsOn:
      - "[resourceId('Microsoft.WinGet/Package', 'ubuntu-distro')]"
    properties:
      testScript: |
        $result = wsl -u root -e bash -c "[ -f /root/.wsl-bootstrapped ] && echo true || echo false"
        return ($result.Trim() -eq "true")
      setScript: |
        Write-Output "ðŸš€ Initializing WSL environment..."
        wsl -u root -e /bin/bash "{{REPO_ROOT_WSL}}/scripts/bootstrap-linux.sh"
      getScript: |
        $result = wsl -u root -e bash -c "[ -f /root/.wsl-bootstrapped ] && echo true || echo false"
        return @{ _inDesiredState = ($result.Trim() -eq "true") }

  - name: vscode-package
    type: Microsoft.WinGet/Package
    properties:
      id: Microsoft.VisualStudioCode
      source: winget

  - name: google-drive-package
    type: Microsoft.WinGet/Package
    properties:
      id: Google.GoogleDrive
      source: winget

  - name: antigravity-package
    type: Microsoft.WinGet/Package
    properties:
      id: Google.Antigravity
      source: winget

  - name: windows-terminal-package
    type: Microsoft.WinGet/Package
    properties:
      id: Microsoft.WindowsTerminal
      source: winget

  - name: docker-desktop-package
    type: Microsoft.WinGet/Package
    properties:
      id: Docker.DockerDesktop
      source: winget

  - name: create-custom-mcp-catalog
    type: Microsoft.DSC.Transitional/PowerShellScript
    dependsOn:
      - "[resourceId('Microsoft.WinGet/Package', 'docker-desktop-package')]"
    properties:
      testScript: |
        $catalogs = docker mcp catalog ls
        return ($catalogs -match 'custom-mcps')
      setScript: |
        Write-Output 'ðŸ“¦ Creating custom MCP catalog...'
        docker mcp catalog create custom-mcps
      getScript: |
        $catalogs = docker mcp catalog ls
        $exists = [bool]($catalogs -match 'custom-mcps')
        return @{ _inDesiredState = $exists }

  - name: git-package
    type: Microsoft.WinGet/Package
    properties:
      id: Git.Git
      source: winget

  - name: github-cli-package
    type: Microsoft.WinGet/Package
    properties:
      id: GitHub.cli
      source: winget

  - name: notion-package
    type: Microsoft.WinGet/Package
    properties:
      id: Notion.Notion
      source: winget

  - name: slack-package
    type: Microsoft.WinGet/Package
    properties:
      id: SlackTechnologies.Slack
      source: winget

  - name: discord-package
    type: Microsoft.WinGet/Package
    properties:
      id: Discord.Discord
      source: winget

  - name: chrome-package
    type: Microsoft.WinGet/Package
    properties:
      id: Google.Chrome.EXE
      source: winget

  - name: steam-package
    type: Microsoft.WinGet/Package
    properties:
      id: Valve.Steam
      source: winget

  # - name: wslconfig-file
  #   type: PSDesiredStateConfiguration/File
  #   properties:
  #     DestinationPath: "{{USER_PROFILE}}\\.wslconfig"
  #     Contents: |
  #       [wsl2]
  #       memory=8GB
  #       processors=4
  #       localhostForwarding=true
  #     Ensure: Present

  - name: winget-admin-settings
    type: Microsoft.WinGet/AdminSettings
    metadata:
      winget:
        securityContext: elevated
    properties:
      settings:
        LocalManifestFiles: false
        ProxyCommandLineOptions: false
        BypassCertificatePinningForMicrosoftStore: false
        InstallerHashOverride: false
        LocalArchiveMalwareScanOverride: false

  - name: windows-personalization-settings
    type: Microsoft.Windows.Settings/WindowsSettings
    metadata:
      winget:
        allowPrerelease: true
        securityContext: elevated
      description: Configure Core Windows UI/UX
    properties:
      AppColorMode: Dark
      SystemColorMode: Dark
      DeveloperMode: true
      TaskbarAlignment: Middle

  - name: explorer-show-hidden-files-registry
    type: Microsoft.Windows/Registry
    properties:
      keyPath: HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced
      valueName: Hidden
      valueData:
        DWord: 1

  - name: explorer-show-file-extensions-registry
    type: Microsoft.Windows/Registry
    properties:
      keyPath: HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\Advanced
      valueName: HideFileExt
      valueData:
        DWord: 0
